<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Dashboard</title>
  <style>
    body { font-family: Arial; background: #fff; color: #111; margin:20px; }
    #currency-select {display: block; margin:0 auto 10px; font-size: 1rem; padding: 4px;}
    table { width:100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 6px; text-align:right; border-bottom:1px solid #ccc; cursor: pointer; }
    .name { text-align:left; }
    .pos { color: green; } .neg { color: red; }
    #summary, #trend { text-align:center; margin-bottom:1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Top 50 Cryptos</h1>
  <select id="currency-select">
    <option value="usd">USD</option>
    <option value="eur">EUR</option>
    <option value="sgd">SGD</option>
    <option value="chf">CHF</option>
  </select>
  <div id="summary">Loading...</div>
  <div id="trend"></div>
  <table>
    <thead><tr>
      <th>#</th>
      <th class="name">Name</th>
      <th>Price</th>
      <th>24h%</th>
      <th>ATH</th>
      <th>Drawdown</th>
      <th>Market Cap</th>
      <th>Volume</th>
      <th>30D Trend</th>
      <th>Galaxy Score</th>
      <th>Avg Sentiment</th>
    </tr></thead>
    <tbody></tbody>
  </table>  <script>
    let exchangeRates = { USD: 1 };

    async function fetchRates(base = 'USD') {
      try {
        const res = await fetch(`https://open.er-api.com/v6/latest/${base}`);
        const data = await res.json();
        exchangeRates = data.rates;
      } catch (e) {
        console.error('Failed to fetch exchange rates:', e);
        exchangeRates = { USD: 1 };
      }
    }

    async function fetchATHs(symbols, vs_currency) {
      const idMap = {
        btc: 'bitcoin', eth: 'ethereum', sol: 'solana', bnb: 'binancecoin', ada: 'cardano',
        xrp: 'ripple', doge: 'dogecoin', dot: 'polkadot', link: 'chainlink', matic: 'polygon',
        trx: 'tron', ltc: 'litecoin', avax: 'avalanche-2', xlm: 'stellar', uni: 'uniswap',
        near: 'near', etc: 'ethereum-classic', fil: 'filecoin', atom: 'cosmos', egld: 'multiversx',
        sui: 'sui'
      };
      const ids = symbols.map(s => idMap[s.toLowerCase()]).filter(Boolean);
      if (ids.length === 0) return {};
      try {
        const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=${vs_currency}&ids=${ids.join(',')}&price_change_percentage=30d`;
        const res = await fetch(url);
        const data = await res.json();
        return Object.fromEntries(data.map(c => [c.symbol.toUpperCase(), {
          ath: c.ath || 0,
          trend_30d: c.price_change_percentage_30d_in_currency || 0
        }]));
      } catch (err) {
        console.error('CoinGecko ATH fetch failed:', err);
        return {};
      }
    }

    async function fetchLunarSentiment(symbols) {
      try {
        const res = await fetch(`/api/lunar-sentiment?symbols=${symbols.join(',')}`);
        const json = await res.json();
        return json;
      } catch (err) {
        console.error('LunarCrush fetch failed:', err);
        return {};
      }
    }

    function renderTable(data, cur, athMap, sentimentMap) {
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';
      data.forEach(c => {
        const rate = exchangeRates[cur] || 1;
        const price = (c.price * rate).toLocaleString();
        const athRaw = athMap[c.symbol.toUpperCase()]?.ath || 0;
        const trend30 = athMap[c.symbol.toUpperCase()]?.trend_30d?.toFixed(2) || '-';
        const sentiment = sentimentMap[c.symbol.toUpperCase()] || {};
        const gs = sentiment.galaxy_score?.toFixed(0) || '-';
        const as = sentiment.average_sentiment?.toFixed(2) || '-';
        const ath = (athRaw * rate).toLocaleString();
        const drawdown = athRaw ? (((c.price - athRaw) * 100) / athRaw).toFixed(2) : '-';
        const marketCap = (c.market_cap * rate / 1e9).toFixed(2) + 'B';
        const volume = (c.volume_24h * rate / 1e9).toFixed(2) + 'B';
        const change = c.percent_change_24h.toFixed(2);
        const changeClass = change >= 0 ? 'pos' : 'neg';
        const drawClass = drawdown >= 0 ? 'pos' : 'neg';
        const trendClass = trend30 >= 0 ? 'pos' : 'neg';

        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${c.rank}</td>
            <td class="name">${c.name} (${c.symbol})</td>
            <td>${cur} ${price}</td>
            <td class="${changeClass}">${change}%</td>
            <td>${cur} ${ath}</td>
            <td class="${drawClass}">${drawdown}%</td>
            <td>${cur} ${marketCap}</td>
            <td>${cur} ${volume}</td>
            <td class="${trendClass}">${trend30}%</td>
            <td>${gs}</td>
            <td>${as}</td>
          </tr>
        `);
      });
    }

    async function loadData() {
      const cur = document.getElementById('currency-select').value.toUpperCase();
      await fetchRates('USD');
      const res = await fetch(`/api/crypto-data?vs_currency=usd`);
      const data = await res.json();
      const symbols = data.map(c => c.symbol);
      const athMap = await fetchATHs(symbols, 'usd');
      const sentimentMap = await fetchLunarSentiment(symbols);

      const best = data.reduce((a, b) => a.percent_change_24h > b.percent_change_24h ? a : b);
      const worst = data.reduce((a, b) => a.percent_change_24h < b.percent_change_24h ? a : b);
      document.getElementById('summary').textContent = `Top 50 Market View in ${cur}`;
      document.getElementById('trend').textContent = `ðŸ“ˆ Best: ${best.name} +${best.percent_change_24h.toFixed(2)}% | ðŸ“‰ Worst: ${worst.name} ${worst.percent_change_24h.toFixed(2)}%`;

      renderTable(data, cur, athMap, sentimentMap);
    }

    document.getElementById('currency-select').addEventListener('change', loadData);
    loadData();
  </script></body>
</html>
